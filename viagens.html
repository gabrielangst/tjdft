<!DOCTYPE html>
<html lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" href="favicon.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeLevaJunto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .trip-card-action-button {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .trip-card:hover .trip-card-action-button {
            opacity: 1;
        }
        .icon-picker-option {
            transition: all 0.2s ease-in-out;
        }
        .icon-picker-option.selected {
            border-color: #3b82f6;
            background-color: #dbeafe;
            transform: scale(1.1);
        }
        #documents-content {
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, margin 0.5s ease-in-out, padding 0.5s ease-in-out;
            max-height: 1000px;
            opacity: 1;
        }
        #documents-panel.collapsed #documents-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-top: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        #documents-toggle-btn svg {
            transition: transform 0.3s ease-in-out;
        }
        #documents-panel.collapsed #documents-toggle-btn svg {
            transform: rotate(180deg);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .status-dot:hover {
            transform: scale(1.2);
        }
        #details-header {
            position: relative;
            background-size: cover;
            background-position: center;
            border-radius: 1rem;
            padding: 2rem;
            overflow: hidden;
            isolation: isolate;
        }
        #details-header::after {
            content: '';
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: -1;
        }

        /* --- ESTILOS ATUALIZADOS PARA O MODO DE REORGANIZAÇÃO --- */

        /* Estilos para o seletor de modo de reorganização */
        .reorg-mode-btn {
            transition: all 0.2s ease-in-out;
        }
        .reorg-mode-btn.active {
            background-color: #ffffff;
            color: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Controle de visibilidade dos handles de arrastar */
        .drag-handle, .activity-drag-handle {
            display: none; /* Escondidos por padrão */
            cursor: grab;
            color: #94a3b8;
        }
        /* Mostra o handle do DIA apenas no modo de dias */
        #daily-itinerary-list.is-reorganizing.mode-days .drag-handle {
            display: block;
        }
        /* Mostra o handle da ATIVIDADE apenas no modo de atividades */
        #daily-itinerary-list.is-reorganizing.mode-activities .activity-item[data-iseditable="true"] .activity-drag-handle {
            display: block;
        }
        
        #daily-itinerary-list.is-reorganizing .add-activity-btn {
            display: none; /* Esconde o botão de adicionar atividade */
        }
        .delete-day-btn {
            display: none; /* Escondido por padrão */
        }
        #daily-itinerary-list.is-reorganizing.mode-days .delete-day-btn {
            display: flex; /* Visível no modo de reorganização de DIAS */
        }
        .day-panel.sortable-ghost {
            background: #dbeafe;
            opacity: 0.8;
            border: 2px dashed #3b82f6;
        }
        .activity-item.sortable-ghost {
            background: #dbeafe !important;
            opacity: 0.8;
            border: 2px dashed #3b82f6;
        }
        .activity-item.sortable-chosen {
            background: #eff6ff !important;
        }
        .insertion-point {
            display: none; /* Escondido por padrão */
            padding: 8px;
            margin-bottom: 1.5rem;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            color: #475569;
            transition: all 0.2s ease-in-out;
        }
        .insertion-point:hover {
            background-color: #e0e7ff;
            border-color: #a5b4fc;
            color: #3730a3;
        }
        #daily-itinerary-list.is-reorganizing.mode-days .insertion-point {
            display: flex; /* Visível no modo de reorganização de DIAS */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">

        <div id="trips-view">
            <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-slate-900">MeLevaJunto</h1>
                    <p class="text-slate-500 mt-1">Veja abaixo as viagens que foram criadas até o momento</p>
                </div>
                <button onclick="openModal('add-trip-modal')" class="mt-4 sm:mt-0 flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="16"></line><line x1="8" x2="16" y1="12" y2="12"></line></svg>
                    <span>Nova Viagem</span>
                </button>
            </header>

            <section id="featured-trips-panel" class="mb-10"></section>

            <main>
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Todas as Viagens</h2>
                <div id="trips-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </main>
        </div>

        <div id="details-view" class="hidden">
            <header id="details-header" class="mb-8">
                 <button onclick="showTripsView()" class="flex items-center gap-2 text-slate-200 hover:text-white font-medium mb-4 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>
                    Voltar para todas as viagens
                </button>
                <h1 id="details-title" class="text-4xl font-bold text-white"></h1>
                <p id="details-dates" class="text-slate-300 mt-1"></p>
                <div id="details-cities-container" class="mt-4 flex flex-wrap gap-2"></div>
                <div class="flex flex-wrap items-center gap-2 mt-4">
                    <button onclick="openEditTripModal()" class="flex items-center gap-2 text-sm bg-white/20 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                        <span>Editar Viagem</span>
                    </button>
                    <button onclick="scrollToItinerary()" class="flex items-center gap-2 text-sm bg-white/20 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-collapse"><path d="m3 10 2.5-2.5L3 5"></path><path d="m3 19 2.5-2.5L3 14"></path><path d="M10 6h11"></path><path d="M10 12h11"></path><path d="M10 18h11"></path></svg>
                        <span>Roteiro</span>
                    </button>
                    <button id="custom-link-btn" style="display: none;" class="flex items-center gap-2 text-sm bg-white/20 text-white font-semibold px-4 py-2 rounded-lg hover:bg-white/30 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                        <span></span> </button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Voos</h2>
                        <button onclick="openModal('add-flight-modal')" class="flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="flights-list" class="space-y-4"></div>
                </section>
                <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Transporte</h2>
                        <button onclick="openModal('add-transport-modal')" class="flex items-center justify-center w-10 h-10 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="transport-list" class="space-y-4"></div>
                </section>
                <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <h2 class="text-2xl font-semibold">Hospedagens</h2>
                            <span id="lodging-status-dot" class="status-dot"></span>
                        </div>
                        <button onclick="openModal('add-lodging-modal')" class="flex items-center justify-center w-10 h-10 bg-purple-100 text-purple-600 rounded-full hover:bg-purple-200 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="lodging-list" class="space-y-4"></div>
                </section>
            </main>

            <section id="documents-panel" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleDocumentsPanel()">
                    <h2 class="text-2xl font-semibold">Documentos</h2>
                    <button id="documents-toggle-btn" class="text-slate-500 hover:text-slate-800 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-up"><path d="m18 15-6-6-6 6"></path></svg>
                    </button>
                </div>
                <div id="documents-content" class="mt-4">
                    <form id="add-document-form" class="flex gap-2 mb-4">
                        <input type="text" id="document-name" placeholder="Ex: Passaporte" class="flex-grow mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <button type="submit" class="flex-shrink-0 bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 self-center h-11 mt-1">Adicionar</button>
                    </form>
                    <div id="documents-list" class="space-y-2">
                    </div>
                </div>
            </section>

            <section id="daily-itinerary-panel" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Roteiro por Dia</h2>
                    <div class="flex items-center gap-2">
                        <div id="reorg-actions-container" class="hidden items-center gap-2">
                            <div class="flex items-center gap-1 bg-slate-300 p-1 rounded-lg">
                                <button id="reorg-mode-days-btn" onclick="switchReorganizationType('days')" class="reorg-mode-btn text-xs font-bold px-3 py-1 rounded-md">Dias</button>
                                <button id="reorg-mode-activities-btn" onclick="switchReorganizationType('activities')" class="reorg-mode-btn text-xs font-bold px-3 py-1 rounded-md">Atividades</button>
                            </div>
                            <button onclick="toggleReorganizationMode(true)" class="text-sm bg-slate-200 text-slate-700 font-semibold px-3 py-1.5 rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button>
                            <button onclick="toggleReorganizationMode(false)" class="text-sm bg-blue-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-blue-700 transition-colors">Concluir</button>
                        </div>
                         <button id="reorg-start-btn" onclick="toggleReorganizationMode(false)" class="text-sm bg-slate-600 text-white font-semibold px-3 py-1.5 rounded-lg hover:bg-slate-700 transition-colors">Reorganizar Roteiro</button>
                        <button id="scroll-to-top-btn" onclick="scrollToTop()" class="text-sm bg-slate-200 text-slate-700 font-semibold px-3 py-1.5 rounded-lg hover:bg-slate-300 transition-colors">Subir</button>
                    </div>
                </div>
                <div id="daily-itinerary-list">
                </div>
            </section>
        </div>
    </div>

    <div id="add-trip-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Nova Viagem</h3>
            <form id="add-trip-form" class="space-y-4">
                <div>
                    <label for="trip-name" class="block text-sm font-medium text-slate-600">Nome da Viagem</label>
                    <input type="text" id="trip-name" placeholder="Ex: Férias na Itália" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="trip-destination" class="block text-sm font-medium text-slate-600">Resumo</label>
                    <input type="text" id="trip-destination" placeholder="Descrição" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label for="trip-start-date" class="block text-sm font-medium text-slate-600">Data de Início</label>
                        <input type="date" id="trip-start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                    </div>
                    <div class="flex-1">
                        <label for="trip-end-date" class="block text-sm font-medium text-slate-600">Data de Fim</label>
                        <input type="date" id="trip-end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-trip-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Viagem</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-flight-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Voo</h3>
            <form id="add-flight-form" class="space-y-4">
                <div>
                    <label for="flight-leg-type" class="block text-sm font-medium text-slate-600">Trecho</label>
                    <select id="flight-leg-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <option value="ida">Ida</option>
                        <option value="volta">Volta</option>
                    </select>
                </div>
                <div>
                    <label for="flight-date" class="block text-sm font-medium text-slate-600">Data do Voo</label>
                    <input type="date" id="flight-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="flight-departure-time" class="block text-sm font-medium text-slate-600">Horário de Saída</label>
                        <input type="time" id="flight-departure-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="flight-arrival-time" class="block text-sm font-medium text-slate-600">Horário de Chegada</label>
                        <input type="time" id="flight-arrival-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="flight-origin" class="block text-sm font-medium text-slate-600">Cidade de Origem</label>
                        <input type="text" id="flight-origin" placeholder="Ex: São Paulo (GRU)" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="flight-destination" class="block text-sm font-medium text-slate-600">Cidade de Destino</label>
                        <input type="text" id="flight-destination" placeholder="Ex: Roma (FCO)" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div>
                    <label for="flight-company" class="block text-sm font-medium text-slate-600">Companhia Aérea</label>
                    <input type="text" id="flight-company" placeholder="Ex: LATAM" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="flight-code" class="block text-sm font-medium text-slate-600">Código do Voo (Opcional)</label>
                        <input type="text" id="flight-code" placeholder="Ex: LA8064" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="flight-type" class="block text-sm font-medium text-slate-600">Tipo de Voo</label>
                        <select id="flight-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                            <option>Voo Direto</option>
                            <option>Com Conexão</option>
                        </select>
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-flight-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Adicionar Voo</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-flight-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Voo</h3>
            <form id="edit-flight-form" class="space-y-4">
                <div>
                    <label for="edit-flight-leg-type" class="block text-sm font-medium text-slate-600">Trecho</label>
                    <select id="edit-flight-leg-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <option value="ida">Ida</option>
                        <option value="volta">Volta</option>
                    </select>
                </div>
                <div>
                    <label for="edit-flight-date" class="block text-sm font-medium text-slate-600">Data do Voo</label>
                    <input type="date" id="edit-flight-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-flight-departure-time" class="block text-sm font-medium text-slate-600">Horário de Saída</label>
                        <input type="time" id="edit-flight-departure-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-flight-arrival-time" class="block text-sm font-medium text-slate-600">Horário de Chegada</label>
                        <input type="time" id="edit-flight-arrival-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-flight-origin" class="block text-sm font-medium text-slate-600">Cidade de Origem</label>
                        <input type="text" id="edit-flight-origin" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-flight-destination" class="block text-sm font-medium text-slate-600">Cidade de Destino</label>
                        <input type="text" id="edit-flight-destination" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div>
                    <label for="edit-flight-company" class="block text-sm font-medium text-slate-600">Companhia Aérea</label>
                    <input type="text" id="edit-flight-company" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-flight-code" class="block text-sm font-medium text-slate-600">Código do Voo (Opcional)</label>
                        <input type="text" id="edit-flight-code" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-flight-type" class="block text-sm font-medium text-slate-600">Tipo de Voo</label>
                        <select id="edit-flight-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                            <option>Voo Direto</option>
                            <option>Com Conexão</option>
                        </select>
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-flight-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="add-transport-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Transporte</h3>
            <form id="add-transport-form" class="space-y-4">
                <div>
                    <label for="transport-type" class="block text-sm font-medium text-slate-600">Tipo de Transporte</label>
                    <select id="transport-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <option value="Trem">Trem</option>
                        <option value="Carro Alugado">Carro Alugado</option>
                        <option value="Ônibus">Ônibus</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="transport-departure-date" class="block text-sm font-medium text-slate-600">Data de Embarque/Retirada</label>
                        <input type="date" id="transport-departure-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="transport-departure-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="transport-departure-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="transport-arrival-date" class="block text-sm font-medium text-slate-600">Data de Chegada/Devolução</label>
                        <input type="date" id="transport-arrival-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="transport-arrival-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="transport-arrival-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div>
                    <label for="transport-origin" class="block text-sm font-medium text-slate-600">Origem</label>
                    <input type="text" id="transport-origin" placeholder="Ex: Roma Termini" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="transport-destination" class="block text-sm font-medium text-slate-600">Destino</label>
                    <input type="text" id="transport-destination" placeholder="Ex: Firenze S.M.N." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="transport-description" class="block text-sm font-medium text-slate-600">Descrição (Opcional)</label>
                    <textarea id="transport-description" rows="3" placeholder="Ex: Trem #9418, vagão 5, assentos 21, 22" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-transport-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold">Adicionar Transporte</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="add-lodging-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Hospedagem</h3>
            <form id="add-lodging-form" class="space-y-4">
                 <div>
                    <label for="lodging-name" class="block text-sm font-medium text-slate-600">Nome do Hotel/Local</label>
                    <input type="text" id="lodging-name" placeholder="Ex: Hotel Coliseu" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="lodging-address" class="block text-sm font-medium text-slate-600">Endereço</label>
                    <input type="text" id="lodging-address" placeholder="Ex: Via Cavour, 123" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="lodging-checkin-date" class="block text-sm font-medium text-slate-600">Data de Check-in</label>
                        <input type="date" id="lodging-checkin-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="lodging-checkin-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="lodging-checkin-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="lodging-checkout-date" class="block text-sm font-medium text-slate-600">Data de Check-out</label>
                        <input type="date" id="lodging-checkout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="lodging-checkout-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="lodging-checkout-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-lodging-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors font-semibold">Adicionar Hospedagem</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-transport-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Transporte</h3>
            <form id="edit-transport-form" class="space-y-4">
                <div>
                    <label for="edit-transport-type" class="block text-sm font-medium text-slate-600">Tipo de Transporte</label>
                    <select id="edit-transport-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                        <option value="Trem">Trem</option>
                        <option value="Carro Alugado">Carro Alugado</option>
                        <option value="Ônibus">Ônibus</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-transport-departure-date" class="block text-sm font-medium text-slate-600">Data de Embarque/Retirada</label>
                        <input type="date" id="edit-transport-departure-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-transport-departure-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="edit-transport-departure-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-transport-arrival-date" class="block text-sm font-medium text-slate-600">Data de Chegada/Devolução</label>
                        <input type="date" id="edit-transport-arrival-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-transport-arrival-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="edit-transport-arrival-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div>
                    <label for="edit-transport-origin" class="block text-sm font-medium text-slate-600">Origem</label>
                    <input type="text" id="edit-transport-origin" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="edit-transport-destination" class="block text-sm font-medium text-slate-600">Destino</label>
                    <input type="text" id="edit-transport-destination" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required="">
                </div>
                <div>
                    <label for="edit-transport-description" class="block text-sm font-medium text-slate-600">Descrição (Opcional)</label>
                    <textarea id="edit-transport-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-transport-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-lodging-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Hospedagem</h3>
            <form id="edit-lodging-form" class="space-y-4">
                 <div>
                    <label for="edit-lodging-name" class="block text-sm font-medium text-slate-600">Nome do Hotel/Local</label>
                    <input type="text" id="edit-lodging-name" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div>
                    <label for="edit-lodging-address" class="block text-sm font-medium text-slate-600">Endereço</label>
                    <input type="text" id="edit-lodging-address" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-lodging-checkin-date" class="block text-sm font-medium text-slate-600">Data de Check-in</label>
                        <input type="date" id="edit-lodging-checkin-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-lodging-checkin-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="edit-lodging-checkin-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-lodging-checkout-date" class="block text-sm font-medium text-slate-600">Data de Check-out</label>
                        <input type="date" id="edit-lodging-checkout-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div>
                        <label for="edit-lodging-checkout-time" class="block text-sm font-medium text-slate-600">Horário</label>
                        <input type="time" id="edit-lodging-checkout-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-lodging-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-trip-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h3 class="text-2xl font-semibold mb-6">Editar Informações da Viagem</h3>
            <form id="edit-trip-form" class="space-y-4">
                <div>
                    <label for="edit-trip-name" class="block text-sm font-medium text-slate-600">Nome da Viagem</label>
                    <input type="text" id="edit-trip-name" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div>
                    <label for="edit-trip-destination" class="block text-sm font-medium text-slate-600">Resumo</label>
                    <input type="text" id="edit-trip-destination" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                </div>
                <div>
                    <label for="edit-trip-image-url" class="block text-sm font-medium text-slate-600">URL da Imagem</label>
                    <input type="url" id="edit-trip-image-url" placeholder="https://exemplo.com/imagem.jpg" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label for="edit-trip-start-date" class="block text-sm font-medium text-slate-600">Data de Início</label>
                        <input type="date" id="edit-trip-start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                    <div class="flex-1">
                        <label for="edit-trip-end-date" class="block text-sm font-medium text-slate-600">Data de Fim</label>
                        <input type="date" id="edit-trip-end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required="">
                    </div>
                </div>
                 <div class="border-t pt-4 mt-2">
                    <label class="block text-sm font-medium text-slate-600 mb-1">Link Personalizado (Opcional)</label>
                    <div>
                        <label for="edit-trip-link-text" class="block text-xs font-medium text-slate-500">Texto do Botão</label>
                        <input type="text" id="edit-trip-link-text" placeholder="Ex: Reservas" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div class="mt-2">
                        <label for="edit-trip-link-url" class="block text-xs font-medium text-slate-500">URL do Link</label>
                        <input type="url" id="edit-trip-link-url" placeholder="https://..." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-trip-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
            <h3 class="text-xl font-semibold mb-4">Confirmar Exclusão</h3>
            <p id="confirm-delete-message" class="text-slate-600 mb-6">Você tem certeza que deseja excluir este item?</p>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal('confirm-delete-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-semibold">Excluir</button>
            </div>
        </div>
    </div>

    <div id="add-activity-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Adicionar Atividade</h3>
            <form id="add-activity-form" class="space-y-4">
                <input type="hidden" id="activity-date">
                <input type="hidden" id="activity-icon" value="passeio">
                <div>
                    <label for="activity-time" class="block text-sm font-medium text-slate-600">Horário</label>
                    <input type="time" id="activity-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                 <div>
                    <label for="activity-name" class="block text-sm font-medium text-slate-600">Nome da Atividade</label>
                    <input type="text" id="activity-name" placeholder="Ex: Visita ao Coliseu" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="activity-type" class="block text-sm font-medium text-slate-600">Tipo de Atividade</label>
                    <select id="activity-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                        <option value="Passeio">Passeio</option>
                        <option value="Cidade">Cidade</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="activity-description" class="block text-sm font-medium text-slate-600">Descrição (Opcional)</label>
                    <textarea id="activity-description" rows="3" placeholder="Ex: Tour guiado com acesso ao subterrâneo." class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></textarea>
                </div>
                <div>
                    <label for="activity-link" class="block text-sm font-medium text-slate-600">Link (Opcional)</label>
                    <input type="url" id="activity-link" placeholder="https://exemplo.com/passeio" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">Ícone</label>
                    <div id="add-icon-picker" class="mt-2 flex flex-wrap gap-2">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('add-activity-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Atividade</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-activity-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 overflow-y-auto max-h-screen">
            <h3 class="text-2xl font-semibold mb-6">Editar Atividade</h3>
            <form id="edit-activity-form" class="space-y-4">
                <input type="hidden" id="edit-activity-id">
                <input type="hidden" id="edit-activity-icon">
                <div>
                    <label for="edit-activity-time" class="block text-sm font-medium text-slate-600">Horário</label>
                    <input type="time" id="edit-activity-time" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="edit-activity-name" class="block text-sm font-medium text-slate-600">Nome da Atividade</label>
                    <input type="text" id="edit-activity-name" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="edit-activity-type" class="block text-sm font-medium text-slate-600">Tipo de Atividade</label>
                    <select id="edit-activity-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                        <option value="Passeio">Passeio</option>
                        <option value="Cidade">Cidade</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label for="edit-activity-description" class="block text-sm font-medium text-slate-600">Descrição (Opcional)</label>
                    <textarea id="edit-activity-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm"></textarea>
                </div>
                <div>
                    <label for="edit-activity-link" class="block text-sm font-medium text-slate-600">Link (Opcional)</label>
                    <input type="url" id="edit-activity-link" placeholder="https://exemplo.com/passeio" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">Ícone</label>
                    <div id="edit-icon-picker" class="mt-2 flex flex-wrap gap-2">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('edit-activity-modal')" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="view-activity-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg m-4 text-center">
            <div id="view-activity-icon" class="mx-auto mb-4 w-12 h-12 flex items-center justify-center bg-slate-100 text-slate-600 rounded-full">
            </div>
            <h3 id="view-activity-name" class="text-2xl font-semibold text-slate-800"></h3>
            <p id="view-activity-time" class="text-slate-500"></p>
            <p id="view-activity-type" class="text-sm font-medium text-slate-500 bg-slate-100 rounded-full px-3 py-1 mt-2 mb-4 inline-block"></p>
            <p id="view-activity-description" class="text-slate-600 mb-4"></p>
            <div id="view-activity-details-list" class="text-sm text-left space-y-2 border-t pt-4"></div>
            <div class="mt-6 space-y-3">
                <div id="view-activity-search-container" style="display: none;">
                    <button id="view-activity-search-btn" class="inline-flex items-center justify-center gap-2 w-full bg-slate-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-slate-700 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
                        <span>Pesquisar</span>
                    </button>
                </div>
                <div id="view-activity-link-container" style="display: none;">
                     <a id="view-activity-link-btn" href="#" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center gap-2 w-full bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-external-link"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" x2="21" y1="14" y2="3"></line></svg>
                        <span>Acessar Link</span>
                    </a>
                </div>
            </div>
            <div class="pt-6 flex justify-center">
                <button type="button" onclick="closeModal('view-activity-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <div id="lodging-coverage-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <div class="flex items-center gap-3 mb-4">
                <span id="lodging-coverage-modal-icon"></span>
                <h3 id="lodging-coverage-modal-title" class="text-xl font-semibold"></h3>
            </div>
            <div id="lodging-coverage-modal-body" class="text-slate-600 text-sm space-y-2"></div>
            <div class="pt-6 flex justify-end">
                <button type="button" onclick="closeModal('lodging-coverage-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Configuração do Firebase
        const firebaseConfigManual = {
            apiKey: "AIzaSyBq4B9LCCat5jof2x9g5KN16UCOgnYo364",
            authDomain: "viagensapp-75077.firebaseapp.com",
            projectId: "viagensapp-75077",
            storageBucket: "viagensapp-75077.appspot.com",
            messagingSenderId: "231052282749",
            appId: "1:231052282749:web:2cd3cca2d77d4112dd1a14",
            databaseURL: "https://viagensapp-75077-default-rtdb.firebaseio.com"
        };
        
        // Variáveis globais
        let db, tripsRef;
        let tripsData = []; 
        let currentTripId = null;
        let currentEditingItemIndex = null;
        let onConfirmAction = () => {};
        
        // Variáveis de estado para reorganização
        let isReorganizing = false;
        let initialTripState = null; // Para o botão de cancelar
        let sortableInstance = null; // Apenas uma instância ativa por vez (para dias)
        let sortableInstances = []; // Para o modo de atividades
        let reorganizationMode = 'days'; // 'days' ou 'activities'


        // Função Utilitária
        function formatDate(dateString, options = { day: 'numeric', month: 'short', year: 'numeric' }) {
            if(!dateString) return 'Data indefinida';
            const date = new Date(dateString + 'T00:00:00Z');
            return date.toLocaleDateString('pt-BR', { timeZone: 'UTC', ...options });
        }

        // Definições de Ícones (sem alterações)
        const ICONS = {
            flight_departure: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>`,
            flight_arrival: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" transform="scale(1,-1)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>`,
            lodging_checkin: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            lodging_checkout: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>`,
            train: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 18h2a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H6a2 2 0 0 0-4 2v10a2 2 0 0 0 2 2h2"/><path d="m12 18-3-3 3-3 3 3-3 3Z"/><path d="M6 12h12"/><path d="M6 6h12"/></svg>`,
            car: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>`,
            bus: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6v6"/><path d="M16 6v6"/><path d="M2 12h19.6"/><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>`,
            transport_other: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 18H8a4 4 0 0 1 0-8h1.5"/><path d="m20 12-3-3 3-3"/><path d="M4 18V6"/></svg>`,
            passeio: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`,
            restaurante: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3z"/></svg>`,
            outro: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12a10.06 10.06 1 0 0-20 0Z"/><path d="M12 12v8a2 2 0 0 0 4 0"/><path d="M12 2v1"/></svg>`,
            basketball: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 0-10 10c0 .2 0 .5.1.7"/><path d="M22 12a10 10 0 0 0-10-10c-.2 0-.5 0-.7.1"/><path d="M2 12h20"/><path d="M12 22a10 10 0 0 0 10-10c0-.2 0-.5-.1-.7"/><path d="M2 12a10 10 0 0 0 10 10c.2 0 .5 0 .7-.1"/></svg>`,
            building: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>`,
            shopping: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>`,
            tree: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-8"/><path d="m17 14-5-5-5 5h10z"/><path d="M8.5 14h7"/><path d="M7 9a5 5 0 0 1 10 0v2H7Z"/></svg>`,
            cake: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16h16"/><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M12 21v-4"/><path d="M12 7a2 2 0 0 1 0-4 2 2 0 0 1 0 4Z"/></svg>`,
            sun: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
            leaf: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 4 13V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M15.5 5.5A3.5 3.5 0 0 1 19 9v1.5a2.5 2.5 0 0 1-5 0V9A3.5 3.5 0 0 1 15.5 5.5Z"/></svg>`,
            mountain: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg>`,
            ferris_wheel: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="2"/><circle cx="12" cy="12" r="10"/><path d="m12 22 3-8 3 8"/><path d="m12 22-3-8-3 8"/><path d="m2 12h8"/><path d="m14 12h8"/><path d="m19.07 4.93-4.24 4.24"/><path d="m4.93 19.07 4.24-4.24"/><path d="m4.93 4.93 4.24 4.24"/><path d="m14.83 19.07-4.24-4.24"/></svg>`,
            music: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
            waves: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/><path d="M3 12c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/><path d="M3 18c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/></svg>`,
            sunglasses: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 14h2"/><path d="M20 14h2"/><path d="M5.2 11.3 4 14"/><path d="M18.8 11.3 20 14"/><circle cx="8" cy="15" r="4"/><circle cx="16" cy="15" r="4"/><path d="M12 15a4 4 0 0 0-4-4h8a4 4 0 0 0-4 4Z"/></svg>`,
            default: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                                ? JSON.parse(__firebase_config)
                                : firebaseConfigManual;

        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                tripsRef = ref(db, 'public_trips');
                setupTripsListener(); 
                setupIconPickers();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        } else {
            console.error("Firebase config is not available.");
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderTripLists() {
            const featuredTripsPanel = document.getElementById('featured-trips-panel');
            const featuredTripsList = document.createElement('div');
            featuredTripsList.id = 'featured-trips-list';
            featuredTripsList.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

            const tripsList = document.getElementById('trips-list');
            
            featuredTripsPanel.innerHTML = '';
            tripsList.innerHTML = '';

            const featuredTrips = tripsData.filter(trip => trip.featured);
            if(featuredTrips.length > 0) {
                featuredTripsPanel.innerHTML = `<h2 class="text-2xl font-bold text-slate-800 mb-4">Viagens Destacadas</h2>`;
                featuredTrips.forEach(trip => {
                    featuredTripsList.appendChild(createTripCard(trip));
                });
                featuredTripsPanel.appendChild(featuredTripsList);
            }
            
            if (tripsData.length === 0) {
                 tripsList.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-slate-700">Nenhuma viagem encontrada.</h3>
                    <p class="text-slate-500 mt-2">Clique em "Nova Viagem" para começar a planejar!</p>
                </div>`;
                return;
            }

            tripsData.forEach(trip => {
                tripsList.appendChild(createTripCard(trip));
            });
        }
        
        function createTripCard(trip) {
            const tripCard = document.createElement('div');
            tripCard.className = 'trip-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform duration-300 relative';
            tripCard.onclick = () => showTripDetails(trip.id);
            
            const starIcon = trip.featured ? 
                `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>` : 
                `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`;

            tripCard.innerHTML = `
                <button onclick="toggleFeatured(event, '${trip.id}')" class="absolute top-3 left-3 z-10 w-8 h-8 flex items-center justify-center bg-white/70 backdrop-blur-sm text-yellow-500 rounded-full hover:bg-white transition-colors">
                    ${starIcon}
                </button>
                <div class="absolute top-3 right-3 z-10 flex gap-2">
                    <button onclick="duplicateTrip(event, '${trip.id}')" title="Duplicar Viagem" class="trip-card-action-button w-8 h-8 flex items-center justify-center bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>
                    </button>
                    <button onclick="deleteTrip(event, '${trip.id}')" title="Excluir Viagem" class="trip-card-action-button w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                </div>
                <div class="h-48 bg-cover bg-center" style="background-image: url('${trip.imageUrl}')"></div>
                <div class="p-6">
                    <h3 class="text-2xl font-bold text-slate-900">${trip.name}</h3>
                    <p class="text-slate-500 mt-1">${trip.destination}</p>
                    <div class="mt-4 text-sm font-medium text-slate-600">
                       ${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}
                    </div>
                </div>
            `;
            return tripCard;
        }

        function renderTripDetails(tripId) {
            currentTripId = tripId;
            const trip = tripsData.find(t => t.id === tripId);

            if (!trip) {
                console.error("Viagem não encontrada:", tripId);
                showTripsView();
                return;
            }

            const header = document.getElementById('details-header');
            header.style.backgroundImage = `url('${trip.imageUrl}')`;

            const citiesContainer = document.getElementById('details-cities-container');
            citiesContainer.innerHTML = ''; 

            if (trip.activities) {
                const cityActivities = Object.values(trip.activities).filter(activity => activity.type === 'Cidade');
                
                if (cityActivities.length > 0) {
                    const uniqueCities = [...new Set(cityActivities.map(activity => activity.name).filter(Boolean))];
                    
                    const cityIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-slate-100"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`;
                    
                    const citiesHtml = uniqueCities.map(city => `
                        <div onclick="scrollToCity('${city.replace(/'/g, "\\'")}')" class="flex items-center gap-2 bg-white/20 px-3 py-1 rounded-full text-sm font-medium backdrop-blur-sm cursor-pointer hover:bg-white/30 transition-colors">
                            ${cityIcon}
                            <span style="color: #ffc95c; font-weight: 600;">${city}</span>
                        </div>
                    `).join('');
                    
                    citiesContainer.innerHTML = citiesHtml;
                }
            }
            
            document.getElementById('details-title').textContent = trip.name;
            document.getElementById('details-dates').textContent = `${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}`;
            
            const customLinkBtn = document.getElementById('custom-link-btn');
            if (trip.customLinkText && trip.customLinkUrl) {
                customLinkBtn.style.display = 'flex';
                customLinkBtn.querySelector('span').textContent = trip.customLinkText;
                customLinkBtn.onclick = () => window.open(trip.customLinkUrl, '_blank');
            } else {
                customLinkBtn.style.display = 'none';
            }

            renderDocuments(trip);
            renderDailyItinerary(trip);
            renderLodgingCoverageStatus(trip);

            const flightTemplate = (flight, index, allFlights) => `
                <div>
                    <p class="font-semibold text-slate-800">${flight.origin} → ${flight.destination}</p>
                    <p class="text-sm text-slate-600">${flight.company} ${flight.code} - ${formatDate(flight.date)}</p>
                    <p class="text-xs text-slate-500">${flight.departureTime} - ${flight.arrivalTime}</p>
                </div>
                <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('flights', ${index}, 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allFlights.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('flights', ${index}, 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditFlightModal(${index})" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('flights', ${index})" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('flights-list', trip.flights, flightTemplate, 'Nenhum voo adicionado.');

            const transportTemplate = (item, index, allTransport) => `
                <div>
                    <p class="font-semibold text-slate-800">${item.type}</p>
                    <p class="text-sm text-slate-600">${item.from ? `${item.from} → ` : ''}${item.to ? item.to : ''}</p>
                    <p class="text-xs text-slate-500">Partida/Retirada: ${formatDate(item.departureDate)} às ${item.departureTime}</p>
                    <p class="text-xs text-slate-500">Chegada/Devolução: ${formatDate(item.arrivalDate)} às ${item.arrivalTime}</p>
                </div>
                <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('transport', ${index}, 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allTransport.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('transport', ${index}, 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditTransportModal(${index})" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('transport', ${index})" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('transport-list', trip.transport, transportTemplate, 'Nenhum transporte adicionado.');

            const lodgingTemplate = (item, index, allLodging) => `
                <div>
                    <p class="font-semibold text-slate-800">${item.name}</p>
                    <p class="text-sm text-slate-600">${item.address}</p>
                    <p class="text-xs text-slate-500">Check-in: ${formatDate(item.checkinDate)}</p>
                    <p class="text-xs text-slate-500">Check-out: ${formatDate(item.checkoutDate)} às ${item.checkoutTime}</p>
                </div>
                 <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('lodging', ${index}, 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allLodging.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('lodging', ${index}, 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditLodgingModal(${index})" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('lodging', ${index})" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('lodging-list', trip.lodging, lodgingTemplate, 'Nenhuma hospedagem adicionada.');
        }

        function renderDocuments(trip) {
            const listElement = document.getElementById('documents-list');
            listElement.innerHTML = '';
            const documents = trip.documents || [];

            if (documents.length === 0) {
                listElement.innerHTML = `<p class="text-slate-500 text-sm text-center py-2">Nenhum documento adicionado.</p>`;
                return;
            }

            documents.forEach((doc, index) => {
                const docElement = document.createElement('div');
                docElement.className = 'flex items-center justify-between p-2 rounded-md hover:bg-slate-50';
                docElement.innerHTML = `
                    <span class="text-slate-700">${doc.name}</span>
                    <div class="flex items-center gap-2">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDocument('${doc.id}', 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === documents.length - 1 ? 'disabled' : ''} onclick="reorderDocument('${doc.id}', 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                        <button onclick="deleteDocument('${doc.id}')" class="text-slate-400 hover:text-red-600 p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                `;
                listElement.appendChild(docElement);
            });
        }
        
        function renderDailyItinerary(trip) {
            const container = document.getElementById('daily-itinerary-list');
            container.innerHTML = '';
            
            if (!trip.startDate || !trip.endDate) { return; }

            const allEvents = [];
            
            if (trip.flights) {
                Object.values(trip.flights).forEach(f => {
                    const flightData = { isEditable: false, ...f };
                    const eventName = `Voo ${f.company}`;
                    if (f.date && f.departureTime) {
                        allEvents.push({ dateTime: new Date(`${f.date}T${f.departureTime}`), name: eventName, description: `Partida de ${f.origin} para ${f.destination}`, icon: ICONS.flight_departure, data: flightData });
                    }
                    if (f.date && f.arrivalTime) {
                        let arrivalDateTime = new Date(`${f.date}T${f.arrivalTime}`);
                        if (arrivalDateTime < new Date(`${f.date}T${f.departureTime}`)) {
                            arrivalDateTime.setDate(arrivalDateTime.getDate() + 1);
                        }
                        allEvents.push({ dateTime: arrivalDateTime, name: eventName, description: `Chegada em ${f.destination}`, icon: ICONS.flight_arrival, data: flightData });
                    }
                });
            }
            if (trip.transport) {
                Object.values(trip.transport).forEach(t => {
                    let eventIcon;
                    const transportData = { isEditable: false, ...t };

                    switch (t.type) {
                        case 'Carro Alugado': 
                            eventIcon = ICONS.car;
                            if (t.departureDate && t.departureTime) allEvents.push({ dateTime: new Date(`${t.departureDate}T${t.departureTime}`), name: `Retirada de Carro`, description: t.description || 'Detalhes do aluguel', icon: eventIcon, data: transportData });
                            if (t.arrivalDate && t.arrivalTime) allEvents.push({ dateTime: new Date(`${t.arrivalDate}T${t.arrivalTime}`), name: `Devolução de Carro`, description: t.description || 'Detalhes da devolução', icon: eventIcon, data: transportData });
                            break;
                        case 'Trem':
                        case 'Ônibus':
                        default:
                            eventIcon = t.type === 'Trem' ? ICONS.train : (t.type === 'Ônibus' ? ICONS.bus : ICONS.transport_other);
                            if (t.departureDate && t.departureTime) allEvents.push({ dateTime: new Date(`${t.departureDate}T${t.departureTime}`), name: `Partida (${t.type})`, description: `De ${t.from || '?'} para ${t.to || '?'}`, icon: eventIcon, data: transportData });
                            if (t.arrivalDate && t.arrivalTime) allEvents.push({ dateTime: new Date(`${t.arrivalDate}T${t.arrivalTime}`), name: `Chegada (${t.type})`, description: `Em ${t.to || '?'}`, icon: eventIcon, data: transportData });
                    }
                });
            }
            if (trip.lodging) {
                Object.values(trip.lodging).forEach(l => {
                    const lodgingData = { isEditable: false, ...l };
                    if (l.checkinDate && l.checkinTime) allEvents.push({ dateTime: new Date(`${l.checkinDate}T${l.checkinTime}`), name: `Check-in`, description: l.name, icon: ICONS.lodging_checkin, data: lodgingData });
                    if (l.checkoutDate && l.checkoutTime) allEvents.push({ dateTime: new Date(`${l.checkoutDate}T${l.checkoutTime}`), name: `Check-out`, description: l.name, icon: ICONS.lodging_checkout, data: lodgingData });
                });
            }
            if (trip.activities) {
                Object.values(trip.activities).forEach(a => {
                    const activityIcon = ICONS[a.icon] || ICONS.default;
                    if(a.date && a.time) allEvents.push({ dateTime: new Date(`${a.date}T${a.time}`), name: a.name || 'Atividade', description: a.description || '', icon: activityIcon, data: { isEditable: true, ...a } });
                });
            }

            allEvents.sort((a,b) => a.dateTime - b.dateTime);

            const groupedByDay = allEvents.reduce((acc, event) => {
                const date = new Date(event.dateTime);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                const day = date.toISOString().split('T')[0];
                if (!acc[day]) acc[day] = [];
                acc[day].push(event);
                return acc;
            }, {});
            
            const cityAnchorsCreated = new Set();
            const startDate = new Date(trip.startDate + 'T00:00:00Z');
            const endDate = new Date(trip.endDate + 'T00:00:00Z');
            const totalTripDays = Math.round((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
            let dayCounter = 1;

            let currentDate = new Date(trip.startDate + 'T00:00:00Z');
            
            container.innerHTML += `<div class="insertion-point" onclick="insertNewDay(0)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>Inserir Novo Dia</span>
            </div>`;
            
            while(currentDate <= endDate) {
                const dayKey = currentDate.toISOString().split('T')[0];
                const dayEvents = groupedByDay[dayKey] || [];
                
                const dayPanel = document.createElement('div');
                dayPanel.className = 'day-panel border-t pt-6 space-y-4';
                dayPanel.dataset.date = dayKey;
                
                for (const event of dayEvents) {
                    if (event.data.isEditable && event.data.type === 'Cidade') {
                        const cityName = event.data.name;
                        if (!cityAnchorsCreated.has(cityName)) {
                            dayPanel.id = `itinerary-day-${cityName.toLowerCase().replace(/\s+/g, '-')}`;
                            cityAnchorsCreated.add(cityName);
                            break; 
                        }
                    }
                }
                
                let eventsHtml = dayEvents.map(event => {
                    const { isEditable, ...eventData } = event.data;
                    const datasetAttributes = Object.entries(eventData)
                        .map(([key, value]) => `data-${key.toLowerCase()}="${String(value || '').replace(/"/g, '&quot;')}"`)
                        .join(' ');
                    
                    let bgColorStyle = '';
                    if (isEditable) {
                        if (eventData.type === 'Cidade') {
                            bgColorStyle = 'background-color: #F4C664;';
                        } else {
                            bgColorStyle = 'background-color: #e6f1ff;';
                        }
                    }
                    const time = event.dateTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});

                    return `
                    <div 
                        class="activity-item flex items-center justify-between gap-4 p-2 rounded-md cursor-pointer hover:bg-slate-100" 
                        style="${bgColorStyle}"
                        onclick='openViewActivityModal(this)'
                        data-icon='${event.icon}'
                        data-time="${time}"
                        data-name="${(event.name || '').replace(/"/g, '&quot;')}"
                        data-description="${(event.description || '').replace(/"/g, '&quot;')}"
                        data-iseditable="${isEditable}"
                        data-activity-id="${eventData.id || ''}"
                        ${datasetAttributes}
                    >
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                             <svg class="activity-drag-handle" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                            <span class="font-bold text-sm w-12 text-right flex-shrink-0">${time}</span>
                            <div class="flex items-center gap-2 text-slate-500 flex-shrink-0">${event.icon || ''}</div>
                            <p class="text-sm text-slate-700 truncate">
                                <strong class="font-semibold">${event.name}</strong>
                                ${event.description ? ` | ${event.description}` : ''}
                            </p>
                        </div>
                        ${isEditable ? `
                        <div class="flex gap-2 items-center flex-shrink-0">
                            <button onclick="event.stopPropagation(); openEditActivityModal('${event.data.id}')" class="text-slate-500 hover:text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteActivity('${event.data.id}')" class="text-slate-500 hover:text-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `}).join('');

                if (dayEvents.length === 0) {
                    eventsHtml = '<p class="text-sm text-slate-400 py-2 ml-4">Nenhuma atividade para este dia.</p>';
                }

                dayPanel.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                         <div class="flex items-center gap-3">
                            <svg class="drag-handle" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                            <h3 class="font-bold text-lg text-slate-800">${dayCounter}/${totalTripDays} | ${formatDate(dayKey, {weekday: 'long', day: 'numeric', month: 'long'})}</h3>
                        </div>
                        <div class="flex items-center gap-2">
                             <button onclick="deleteDay('${dayKey}')" class="delete-day-btn flex items-center justify-center w-10 h-10 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                            <button onclick="openAddActivityModal('${dayKey}')" class="add-activity-btn flex items-center justify-center w-10 h-10 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-colors">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div class="activity-list border-l-2 border-slate-100 pl-2 space-y-1" data-date="${dayKey}">
                        ${eventsHtml}
                    </div>
                `;
                container.appendChild(dayPanel);

                container.innerHTML += `<div class="insertion-point" onclick="insertNewDay(${dayCounter})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>Inserir Novo Dia</span>
                </div>`;

                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                dayCounter++;
            }
        }
        
        function renderDetailList(elementId, items, itemTemplate, emptyMessage) {
            const listElement = document.getElementById(elementId);
            listElement.innerHTML = '';
            const itemsArray = items ? Object.values(items) : [];
            if (itemsArray.length === 0) {
                listElement.innerHTML = `<p class="text-slate-500 text-sm">${emptyMessage}</p>`;
                return;
            }
            itemsArray.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-start border-l-4 border-slate-200 pl-4 py-2';
                itemDiv.innerHTML = itemTemplate(item, index, itemsArray);
                listElement.appendChild(itemDiv);
            });
        }
        
        function setupTripsListener() {
            if (!tripsRef) return;
            onValue(tripsRef, (snapshot) => {
                const data = snapshot.val();
                tripsData = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                
                tripsData.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

                if (document.getElementById('details-view').classList.contains('hidden')) {
                    renderTripLists();
                } else if(currentTripId) {
                    const currentTripExists = tripsData.some(t => t.id === currentTripId);
                    if (currentTripExists) {
                        renderTripDetails(currentTripId);

			// --- ADICIONE ESTE BLOCO DE CÓDIGO AQUI ---
                        // Reativa o SortableJS se estivermos no modo de reorganização,
                        // pois o renderTripDetails() acima redesenhou o DOM.
                        if (isReorganizing) {
                            if (reorganizationMode === 'days') {
                                initializeDaySorting();
                            } else if (reorganizationMode === 'activities') {
                                initializeActivitySorting();
                            }
                        }
                        // --- FIM DA ALTERAÇÃO ---


                    } else {
                        showTripsView();
                    }
                }
            }, error => {
                console.error("Error listening to Realtime Database:", error);
            });
        }

        function setupIconPickers() {
            const iconOptions = {
                passeio: ICONS.passeio, restaurante: ICONS.restaurante, shopping: ICONS.shopping, music: ICONS.music,
                building: ICONS.building, tree: ICONS.tree, leaf: ICONS.leaf, sun: ICONS.sun, cake: ICONS.cake, 
                mountain: ICONS.mountain, ferris_wheel: ICONS.ferris_wheel, basketball: ICONS.basketball, 
                waves: ICONS.waves, sunglasses: ICONS.sunglasses,
                outro: ICONS.outro
            };

            const populatePicker = (pickerId) => {
                const picker = document.getElementById(pickerId);
                picker.innerHTML = '';
                for (const [name, svg] of Object.entries(iconOptions)) {
                    if (!svg) {
                        console.warn(`Icon '${name}' is missing in ICONS object.`);
                        continue;
                    }
                    const option = document.createElement('div');
                    option.className = 'icon-picker-option cursor-pointer p-2 border-2 border-slate-200 rounded-full';
                    option.dataset.icon = name;
                    option.innerHTML = svg.replace('w-5 h-5', 'w-6 h-6');
                    picker.appendChild(option);
                }
            };

            const handlePickerClick = (e, formId) => {
                const target = e.target.closest('.icon-picker-option');
                if (!target) return;

                const iconName = target.dataset.icon;
                const picker = target.parentElement;
                const hiddenInput = document.getElementById(formId);

                hiddenInput.value = iconName;

                picker.querySelectorAll('.icon-picker-option').forEach(opt => opt.classList.remove('selected'));
                target.classList.add('selected');
            };

            populatePicker('add-icon-picker');
            populatePicker('edit-icon-picker');

            document.getElementById('add-icon-picker').addEventListener('click', (e) => handlePickerClick(e, 'activity-icon'));
            document.getElementById('edit-icon-picker').addEventListener('click', (e) => handlePickerClick(e, 'edit-activity-icon'));
        }

        function renderLodgingCoverageStatus(trip) {
            const statusDot = document.getElementById('lodging-status-dot');
            if (!trip.startDate || !trip.endDate) {
                statusDot.style.display = 'none';
                return;
            }

            const requiredNights = [];
            let currentDate = new Date(trip.startDate + 'T00:00:00Z');
            const endDate = new Date(trip.endDate + 'T00:00:00Z');
            while (currentDate < endDate) {
                requiredNights.push(currentDate.toISOString().split('T')[0]);
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }

            const coveredNights = new Set();
            const lodgings = trip.lodging ? Object.values(trip.lodging) : [];
            lodgings.forEach(l => {
                let checkin = new Date(l.checkinDate + 'T00:00:00Z');
                const checkout = new Date(l.checkoutDate + 'T00:00:00Z');
                while (checkin < checkout) {
                    coveredNights.add(checkin.toISOString().split('T')[0]);
                    checkin.setUTCDate(checkin.getUTCDate() + 1);
                }
            });

            const missingNights = requiredNights.filter(night => !coveredNights.has(night));

            const modalTitle = document.getElementById('lodging-coverage-modal-title');
            const modalBody = document.getElementById('lodging-coverage-modal-body');
            const modalIcon = document.getElementById('lodging-coverage-modal-icon');

            if (missingNights.length === 0 && requiredNights.length > 0) {
                statusDot.style.backgroundColor = '#22c55e';
                statusDot.onclick = () => {
                    modalTitle.textContent = "Cobertura de Hospedagem Completa";
                    modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`;
                    modalBody.innerHTML = `<p>Todas as ${requiredNights.length} noites da sua viagem possuem hospedagem agendada.</p>`;
                    openModal('lodging-coverage-modal');
                };
            } else {
                statusDot.style.backgroundColor = '#ef4444';
                statusDot.onclick = () => {
                    modalTitle.textContent = "Hospedagem Incompleta";
                     modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>`;
                    if (requiredNights.length === 0) {
                         modalBody.innerHTML = `<p>A viagem não tem noites (começa e termina no mesmo dia).</p>`;
                    } else {
                         modalBody.innerHTML = `
                            <p>Está faltando agendar hospedagem para <strong>${missingNights.length} noite(s)</strong>:</p>
                            <ul class="list-disc pl-5 mt-2 space-y-1">
                                ${missingNights.map(night => `<li>${formatDate(night, {weekday: 'short', day: 'numeric', month: 'long'})}</li>`).join('')}
                            </ul>
                        `;
                    }
                    openModal('lodging-coverage-modal');
                };
            }
             statusDot.style.display = 'block';
        }
        
        // --- CONTROLE DE NAVEGAÇÃO, MODAIS E FORMULÁRIOS ---
        window.scrollToCity = (cityName) => {
            const targetId = `itinerary-day-${cityName.toLowerCase().replace(/\s+/g, '-')}`;
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                console.warn(`Âncora para a cidade "${cityName}" não encontrada.`);
            }
        };
        
        window.showTripsView = () => {
            document.getElementById('trips-view').classList.remove('hidden');
            document.getElementById('details-view').classList.add('hidden');
            currentTripId = null;
        }

        window.showTripDetails = (tripId) => {
            window.scrollTo({ top: 0, behavior: 'smooth' });

            document.getElementById('documents-panel').classList.add('collapsed');
            renderTripDetails(tripId);
            document.getElementById('trips-view').classList.add('hidden');
            document.getElementById('details-view').classList.remove('hidden');
        }
        
        window.toggleDocumentsPanel = () => {
            const panel = document.getElementById('documents-panel');
            panel.classList.toggle('collapsed');
        }

        window.openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.replace('hidden', 'flex');

            if (currentTripId) {
                const trip = tripsData.find(t => t.id === currentTripId);
                if (trip && trip.startDate) {
                    const tripStartDate = trip.startDate;
                    
                    if (modalId === 'add-flight-modal') {
                        document.getElementById('flight-date').value = tripStartDate;
                    } else if (modalId === 'add-transport-modal') {
                        document.getElementById('transport-departure-date').value = tripStartDate;
                        document.getElementById('transport-arrival-date').value = tripStartDate;
                    } else if (modalId === 'add-lodging-modal') {
                        document.getElementById('lodging-checkin-date').value = tripStartDate;
                        document.getElementById('lodging-checkout-date').value = tripStartDate;
                    }
                }
            }
        }

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.replace('flex', 'hidden');
            const form = document.getElementById(modalId).querySelector('form');
            if (form) form.reset();
            if (modalId === 'confirm-delete-modal') onConfirmAction = () => {};
        }
        
        window.scrollToItinerary = () => {
            const itineraryPanel = document.getElementById('daily-itinerary-panel');
            if (itineraryPanel) {
                itineraryPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };

        window.scrollToTop = () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.openEditTripModal = () => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            document.getElementById('edit-trip-name').value = trip.name;
            document.getElementById('edit-trip-destination').value = trip.destination;
            document.getElementById('edit-trip-start-date').value = trip.startDate;
            document.getElementById('edit-trip-end-date').value = trip.endDate;
            document.getElementById('edit-trip-image-url').value = trip.imageUrl || '';
            document.getElementById('edit-trip-link-text').value = trip.customLinkText || '';
            document.getElementById('edit-trip-link-url').value = trip.customLinkUrl || '';

            openModal('edit-trip-modal');
        };

        window.openViewActivityModal = (element) => {
            
const isReorganizingActive = document.getElementById('daily-itinerary-list').classList.contains('is-reorganizing');
            if (isReorganizingActive) {
                return; // Sai da função e não faz nada se estiver no modo de reorganização
            }

const ds = element.dataset;
            document.getElementById('view-activity-icon').innerHTML = ds.icon.replace('w-5 h-5', 'w-8 h-8');
            document.getElementById('view-activity-name').textContent = ds.name;
            document.getElementById('view-activity-time').textContent = ds.time;

            const typeElement = document.getElementById('view-activity-type');
            if (ds.type && ds.iseditable === 'true') {
                typeElement.textContent = ds.type;
                typeElement.style.display = 'inline-block';
            } else {
                typeElement.style.display = 'none';
            }
            
            const descriptionElement = document.getElementById('view-activity-description');
            descriptionElement.textContent = ds.description;
            descriptionElement.style.display = ds.description ? 'block' : 'none';

            const detailsList = document.getElementById('view-activity-details-list');
            let detailsHtml = '';

            if (ds.iseditable !== 'true') {
                 detailsHtml += `<p class="font-semibold text-base text-slate-800">${ds.name}</p>`;
            }

            if (ds.from || ds.to) {
                detailsHtml += `<p class="mt-2"><strong class="font-semibold text-slate-600">Trajeto:</strong> ${ds.from || 'N/A'} → ${ds.to || 'N/A'}</p>`;
            }
            if(ds.address) {
                detailsHtml += `<p class="mt-2"><strong class="font-semibold text-slate-600">Endereço:</strong> ${ds.address}</p>`;
            }
            
            if (ds.description && ds.iseditable !== 'true') {
                 detailsHtml += `<p class="mt-2"><strong class="font-semibold text-slate-600">Detalhes:</strong> ${ds.description}</p>`;
            }

            detailsList.innerHTML = detailsHtml;
            detailsList.style.display = detailsHtml ? 'block' : 'none';

            const linkContainer = document.getElementById('view-activity-link-container');
            const linkBtn = document.getElementById('view-activity-link-btn');
            
            if (ds.link && ds.link.trim() !== '' && ds.link.trim() !== 'undefined') {
                linkBtn.href = ds.link;
                linkContainer.style.display = 'block';
            } else {
                linkContainer.style.display = 'none';
            }

            const searchContainer = document.getElementById('view-activity-search-container');
            const searchBtn = document.getElementById('view-activity-search-btn');

            if (ds.name && ds.iseditable === 'true') {
                searchContainer.style.display = 'block';
                searchBtn.onclick = () => {
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(ds.name)}`, '_blank');
                };
            } else {
                searchContainer.style.display = 'none';
            }

            openModal('view-activity-modal');
        }
        
        window.openEditFlightModal = (index) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const flight = trip?.flights ? Object.values(trip.flights)[index] : null;
            if (!flight) return;
            currentEditingItemIndex = index;
            document.getElementById('edit-flight-leg-type').value = flight.legType;
            document.getElementById('edit-flight-date').value = flight.date;
            document.getElementById('edit-flight-departure-time').value = flight.departureTime;
            document.getElementById('edit-flight-arrival-time').value = flight.arrivalTime;
            document.getElementById('edit-flight-origin').value = flight.origin;
            document.getElementById('edit-flight-destination').value = flight.destination;
            document.getElementById('edit-flight-company').value = flight.company;
            document.getElementById('edit-flight-code').value = flight.code;
            document.getElementById('edit-flight-type').value = flight.flightType;
            openModal('edit-flight-modal');
        }

        window.openEditTransportModal = (index) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const transport = trip?.transport ? Object.values(trip.transport)[index] : null;
            if (!transport) return;
            currentEditingItemIndex = index;
            document.getElementById('edit-transport-type').value = transport.type;
            document.getElementById('edit-transport-origin').value = transport.from;
            document.getElementById('edit-transport-destination').value = transport.to;
            document.getElementById('edit-transport-description').value = transport.description;
            document.getElementById('edit-transport-departure-date').value = transport.departureDate;
            document.getElementById('edit-transport-departure-time').value = transport.departureTime;
            document.getElementById('edit-transport-arrival-date').value = transport.arrivalDate;
            document.getElementById('edit-transport-arrival-time').value = transport.arrivalTime;
            document.getElementById('edit-transport-type').dispatchEvent(new Event('change'));
            openModal('edit-transport-modal');
        }
        
        window.openEditLodgingModal = (index) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const lodging = trip?.lodging ? Object.values(trip.lodging)[index] : null;
            if (!lodging) return;
            currentEditingItemIndex = index;
            document.getElementById('edit-lodging-name').value = lodging.name;
            document.getElementById('edit-lodging-address').value = lodging.address;
            document.getElementById('edit-lodging-checkin-date').value = lodging.checkinDate;
            document.getElementById('edit-lodging-checkin-time').value = lodging.checkinTime;
            document.getElementById('edit-lodging-checkout-date').value = lodging.checkoutDate;
            document.getElementById('edit-lodging-checkout-time').value = lodging.checkoutTime;
            openModal('edit-lodging-modal');
        }

        window.openEditActivityModal = (activityId) => {
            event.stopPropagation();
            const trip = tripsData.find(t => t.id === currentTripId);
            const activity = Object.values(trip.activities).find(a => a.id === activityId);
            if (activity) {
                document.getElementById('edit-activity-id').value = activity.id;
                document.getElementById('edit-activity-time').value = activity.time;
                document.getElementById('edit-activity-name').value = activity.name || '';
                document.getElementById('edit-activity-type').value = activity.type;
                document.getElementById('edit-activity-description').value = activity.description || '';
                document.getElementById('edit-activity-link').value = activity.link || '';
                document.getElementById('edit-activity-icon').value = activity.icon;

                const picker = document.getElementById('edit-icon-picker');
                picker.querySelectorAll('.icon-picker-option').forEach(opt => opt.classList.remove('selected'));
                const selectedIcon = picker.querySelector(`[data-icon="${activity.icon}"]`);
                if(selectedIcon) selectedIcon.classList.add('selected');
                
                openModal('edit-activity-modal');
            }
        };

        function showConfirmDelete(message, onConfirm) {
            document.getElementById('confirm-delete-message').innerText = message;
            onConfirmAction = onConfirm;
            openModal('confirm-delete-modal');
        }

        async function addDetail(category) {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;
            let newItem = {};
            if (category === 'flights') {
                newItem = { 
                    legType: document.getElementById('flight-leg-type').value, date: document.getElementById('flight-date').value, departureTime: document.getElementById('flight-departure-time').value, arrivalTime: document.getElementById('flight-arrival-time').value, origin: document.getElementById('flight-origin').value, destination: document.getElementById('flight-destination').value, company: document.getElementById('flight-company').value, code: document.getElementById('flight-code').value, flightType: document.getElementById('flight-type').value,
                };
            } else if (category === 'transport') {
                newItem = { 
                    type: document.getElementById('transport-type').value, from: document.getElementById('transport-origin').value, to: document.getElementById('transport-destination').value, description: document.getElementById('transport-description').value, departureDate: document.getElementById('transport-departure-date').value, departureTime: document.getElementById('transport-departure-time').value, arrivalDate: document.getElementById('transport-arrival-date').value, arrivalTime: document.getElementById('transport-arrival-time').value,
                };
            } else if (category === 'lodging') {
                newItem = { 
                    name: document.getElementById('lodging-name').value, address: document.getElementById('lodging-address').value, checkinDate: document.getElementById('lodging-checkin-date').value, checkinTime: document.getElementById('lodging-checkin-time').value, checkoutDate: document.getElementById('lodging-checkout-date').value, checkoutTime: document.getElementById('lodging-checkout-time').value,
                };
            }
            const currentItems = trip[category] ? [...Object.values(trip[category])] : [];
            currentItems.push(newItem);
            const updates = {};
            updates[`/${currentTripId}/${category}`] = currentItems;
            await update(tripsRef, updates);
            let modalIdToClose = category === 'flights' ? 'add-flight-modal' : (category === 'transport' ? 'add-transport-modal' : 'add-lodging-modal');
            if (modalIdToClose) closeModal(modalIdToClose);
        }
        
        window.deleteTrip = async (event, tripId) => {
            event.stopPropagation();
            showConfirmDelete('Tem certeza que deseja excluir esta viagem?', async () => {
                const tripToDeleteRef = ref(db, `public_trips/${tripId}`);
                await remove(tripToDeleteRef);
                closeModal('confirm-delete-modal');
            });
        }
        
        window.duplicateTrip = async (event, tripId) => {
            event.stopPropagation();

            const originalTrip = tripsData.find(t => t.id === tripId);
            if (!originalTrip) {
                console.error("Viagem não encontrada para duplicação");
                return;
            }

            const newTrip = JSON.parse(JSON.stringify(originalTrip));

            delete newTrip.id;

            newTrip.name = `${originalTrip.name} (Cópia)`;
            newTrip.featured = false;

            if (newTrip.activities) {
                const activitiesArray = Array.isArray(newTrip.activities) 
                    ? newTrip.activities 
                    : Object.values(newTrip.activities);
                activitiesArray.forEach((activity, index) => {
                    activity.id = `${Date.now()}-${index}`;
                });
                newTrip.activities = activitiesArray;
            }

            if (newTrip.documents) {
                 newTrip.documents.forEach((doc, index) => {
                    doc.id = `${Date.now()}-${index}`;
                });
            }

            try {
                const newTripRef = push(tripsRef);
                await set(newTripRef, newTrip);
            } catch (error) {
                console.error("Falha ao duplicar a viagem:", error);
            }
        };

        window.deleteDetailItem = async (category, index) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip || !trip[category]) return;
            const currentItems = Object.values(trip[category]);
            showConfirmDelete(`Tem certeza que deseja excluir o item?`, async () => {
                currentItems.splice(index, 1);
                const updates = {};
                updates[`/${currentTripId}/${category}`] = currentItems;
                await update(tripsRef, updates);
                closeModal('confirm-delete-modal');
            });
        }
        
        window.reorderDetailItem = async (category, index, direction) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const items = trip[category] ? [...Object.values(trip[category])] : [];
            const newIndex = direction === 'up' ? index - 1 : index + 1;
            if (newIndex < 0 || newIndex >= items.length) return;
            [items[index], items[newIndex]] = [items[newIndex], items[index]];
            const updates = {};
            updates[`/${currentTripId}/${category}`] = items;
            await update(tripsRef, updates);
        }
        
        window.openAddActivityModal = (date) => {
            document.getElementById('activity-date').value = date;
            const picker = document.getElementById('add-icon-picker');
            const hiddenInput = document.getElementById('activity-icon');
            hiddenInput.value = 'passeio'; 
            picker.querySelectorAll('.icon-picker-option').forEach(opt => opt.classList.remove('selected'));
            picker.querySelector('[data-icon="passeio"]').classList.add('selected');
            openModal('add-activity-modal');
        };

        window.deleteActivity = (activityId) => {
            event.stopPropagation();
            showConfirmDelete('Tem certeza que deseja excluir esta atividade?', async () => {
                const trip = tripsData.find(t => t.id === currentTripId);
                const currentActivities = trip.activities ? Object.values(trip.activities) : [];
                const updatedActivities = currentActivities.filter(a => a.id !== activityId);
                const updates = { [`/${currentTripId}/activities`]: updatedActivities };
                await update(tripsRef, updates);
                closeModal('confirm-delete-modal');
            });
        };

        window.deleteDocument = async (docId) => {
             showConfirmDelete('Tem certeza que deseja excluir este documento?', async () => {
                const trip = tripsData.find(t => t.id === currentTripId);
                if (!trip || !trip.documents) return;
                const updatedDocuments = trip.documents.filter(d => d.id !== docId);
                const updates = { [`/${currentTripId}/documents`]: updatedDocuments };
                await update(tripsRef, updates);
                closeModal('confirm-delete-modal');
            });
        };
        
        window.reorderDocument = async (docId, direction) => {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            const documents = trip.documents ? [...trip.documents] : [];
            const index = documents.findIndex(d => d.id === docId);

            if (index === -1) return; 

            const newIndex = direction === 'up' ? index - 1 : index + 1;

            if (newIndex < 0 || newIndex >= documents.length) return;

            [documents[index], documents[newIndex]] = [documents[newIndex], documents[index]];

            const updates = { [`/${currentTripId}/documents`]: documents };
            await update(tripsRef, updates);
        };

        window.toggleFeatured = async (event, tripId) => {
            event.stopPropagation();
            const trip = tripsData.find(t => t.id === tripId);
            if (!trip) return;
            const newFeaturedStatus = !trip.featured;
            const updates = { [`/${tripId}/featured`]: newFeaturedStatus };
            await update(tripsRef, updates);
        }

        // --- SEÇÃO ATUALIZADA: LÓGICA DE REORGANIZAÇÃO DO ROTEIRO COM DUPLO MODO ---
        
        // Função para salvar a ordem das atividades (MODO ATIVIDADES)
        async function updateActivityOrderAndDate() {
            if (!currentTripId) return;
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            const allActivityElements = document.querySelectorAll('.activity-item[data-activity-id]');
            let allCurrentActivities = trip.activities ? JSON.parse(JSON.stringify(Object.values(trip.activities))) : [];
            let updatedActivities = [];

            allActivityElements.forEach(el => {
                const activityId = el.dataset.activityId;
                const newDate = el.closest('.activity-list').dataset.date;
                const activityData = allCurrentActivities.find(a => a.id === activityId);
                if (activityData) {
                    activityData.date = newDate;
                    updatedActivities.push(activityData);
                }
            });

            allCurrentActivities.forEach(act => {
                if (!updatedActivities.find(a => a.id === act.id)) { updatedActivities.push(act); }
            });

            const updates = { [`/${currentTripId}/activities`]: updatedActivities };
            await update(tripsRef, updates);
        }

        // Função para inicializar o arraste de ATIVIDADES
        function initializeActivitySorting() {
            sortableInstances.forEach(instance => instance.destroy());
            sortableInstances = [];
            const activityLists = document.querySelectorAll('.activity-list');
            
            activityLists.forEach(list => {
                const instance = new Sortable(list, {
                    group: 'shared-activities', animation: 150, handle: '.activity-drag-handle',
                    draggable: '.activity-item[data-iseditable="true"]',
                    onEnd: (evt) => updateActivityOrderAndDate(),
                });
                sortableInstances.push(instance);
            });
        }

        // Função para salvar a ordem dos dias (MODO DIAS - Lógica original)
        async function remapAndSaveDays(tripId, daysArray) {
            const trip = tripsData.find(t => t.id === tripId);
            let currentDate = new Date(trip.startDate + 'T00:00:00Z');
            const newActivities = [];
            
            daysArray.forEach(dayObj => {
                const isoDate = currentDate.toISOString().split('T')[0];
                dayObj.activities.forEach(act => {
                    act.date = isoDate;
                    newActivities.push(act);
                });
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            });
            
            const newEndDate = new Date(currentDate);
            newEndDate.setUTCDate(newEndDate.getUTCDate() - 1);
            
            const updates = {
                [`/${tripId}/activities`]: newActivities,
                [`/${tripId}/endDate`]: newEndDate.toISOString().split('T')[0]
            };
            
            await update(tripsRef, updates);
        }
        
        // Helper para obter os dias (usado pelo modo de dias)
        function getDaysArray(trip) {
            const allActivities = trip.activities ? Object.values(trip.activities) : [];
            const groupedByDay = allActivities.reduce((acc, act) => {
                const date = act.date;
                if (!acc[date]) acc[date] = [];
                acc[date].push(act);
                return acc;
            }, {});

            let daysArray = [];
            if (trip.startDate && trip.endDate) {
                let currentDate = new Date(trip.startDate + 'T00:00:00Z');
                const endDate = new Date(trip.endDate + 'T00:00:00Z');
                while(currentDate <= endDate) {
                    const dayKey = currentDate.toISOString().split('T')[0];
                    daysArray.push({
                        date: dayKey,
                        activities: groupedByDay[dayKey] || []
                    });
                    currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                }
            }
            return daysArray;
        }
        
        // Função para reorganizar os dias (MODO DIAS)
        window.reorganizeItinerary = async (oldIndex, newIndex) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;
            let daysArray = getDaysArray(trip);
            const [movedItem] = daysArray.splice(oldIndex, 1);
            daysArray.splice(newIndex, 0, movedItem);
            await remapAndSaveDays(currentTripId, daysArray);
        };

        // Função para inicializar o arraste de DIAS
        function initializeDaySorting() {
            if (sortableInstance) sortableInstance.destroy();
            const list = document.getElementById('daily-itinerary-list');
            
            sortableInstance = new Sortable(list, {
                animation: 150, handle: '.drag-handle', draggable: '.day-panel',
                onEnd: (evt) => {
                    if (evt.oldDraggableIndex !== evt.newDraggableIndex) {
                        reorganizeItinerary(evt.oldDraggableIndex, evt.newDraggableIndex);
                    }
                },
            });
        }
        
        // NOVA FUNÇÃO: Alterna entre os modos de reorganização
        window.switchReorganizationType = (type) => {
            if (reorganizationMode === type) return; // Não faz nada se já estiver no modo
            reorganizationMode = type;
            const list = document.getElementById('daily-itinerary-list');
            const daysBtn = document.getElementById('reorg-mode-days-btn');
            const activitiesBtn = document.getElementById('reorg-mode-activities-btn');

            // Destrói instâncias anteriores para evitar conflitos
            if (sortableInstance) sortableInstance.destroy();
            sortableInstances.forEach(i => i.destroy());
            sortableInstance = null;
            sortableInstances = [];

            if (type === 'days') {
                list.classList.remove('mode-activities');
                list.classList.add('mode-days');
                daysBtn.classList.add('active');
                activitiesBtn.classList.remove('active');
                initializeDaySorting();
            } else { // type === 'activities'
                list.classList.remove('mode-days');
                list.classList.add('mode-activities');
                activitiesBtn.classList.add('active');
                daysBtn.classList.remove('active');
                initializeActivitySorting();
            }
        }

        // FUNÇÃO MESTRE: Controla a entrada e saída do modo de reorganização geral
        window.toggleReorganizationMode = (isCancelling) => {
            const list = document.getElementById('daily-itinerary-list');
            const startBtn = document.getElementById('reorg-start-btn');
            const actionsContainer = document.getElementById('reorg-actions-container');
            const scrollTopBtn = document.getElementById('scroll-to-top-btn'); 
            
            isReorganizing = !list.classList.contains('is-reorganizing');
            list.classList.toggle('is-reorganizing', isReorganizing);

            if (isReorganizing) {
                const trip = tripsData.find(t => t.id === currentTripId);
                initialTripState = { 
                    activities: trip.activities ? JSON.parse(JSON.stringify(trip.activities)) : {}, 
                    endDate: trip.endDate 
                };
                startBtn.style.display = 'none';
                actionsContainer.style.display = 'flex';
                scrollTopBtn.style.display = 'none';
                // Inicia por padrão no modo de dias
                switchReorganizationType('days');
            } else {
                if (isCancelling && initialTripState) {
                    const updates = {
                        [`/${currentTripId}/activities`]: initialTripState.activities,
                        [`/${currentTripId}/endDate`]: initialTripState.endDate
                    };
                    update(tripsRef, updates);
                }
                initialTripState = null;
                startBtn.style.display = 'block';
                actionsContainer.style.display = 'none';
                scrollTopBtn.style.display = 'block'; 
                
                // Limpa as classes de modo e destrói todas as instâncias de sortable
                list.classList.remove('mode-days', 'mode-activities');
                if (sortableInstance) sortableInstance.destroy();
                sortableInstances.forEach(i => i.destroy());
                sortableInstance = null;
                sortableInstances = [];
            }
        };

        window.insertNewDay = async (index) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            let daysArray = getDaysArray(trip);
            daysArray.splice(index, 0, { date: 'new', activities: [] });

            await remapAndSaveDays(currentTripId, daysArray);
        };
        
        window.deleteDay = async (dayKey) => {
            const trip = tripsData.find(t => t.id === currentTripId);
            if (!trip) return;

            let daysArray = getDaysArray(trip);
            if (daysArray.length <= 1) {
                alert("Não é possível excluir o único dia da viagem.");
                return;
            }

            showConfirmDelete(`Tem certeza que deseja excluir o dia ${formatDate(dayKey, {weekday: 'long', day: 'numeric', month: 'long'})} e todas as suas atividades?`, async () => {
                let daysArray = getDaysArray(trip);
                const dayIndex = daysArray.findIndex(day => day.date === dayKey);
                
                if (dayIndex > -1) {
                    daysArray.splice(dayIndex, 1);
                    await remapAndSaveDays(currentTripId, daysArray);
                }
                closeModal('confirm-delete-modal');
            });
        };

        // --- LISTENERS DOS FORMULÁRIOS ---
        document.getElementById('add-trip-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const tripName = document.getElementById('trip-name').value;
            const newTrip = {
                name: tripName,
                destination: document.getElementById('trip-destination').value,
                startDate: document.getElementById('trip-start-date').value,
                endDate: document.getElementById('trip-end-date').value,
                imageUrl: `https://placehold.co/600x400/a3e635/1e293b?text=${encodeURIComponent(tripName)}`,
                featured: false,
                customLinkText: '',
                customLinkUrl: ''
            };
            const newTripRef = push(tripsRef);
            await set(newTripRef, newTrip);
            closeModal('add-trip-modal');
        });

        document.getElementById('add-document-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentTripId) return;

            const input = document.getElementById('document-name');
            const docName = input.value.trim();
            if (!docName) return;

            const trip = tripsData.find(t => t.id === currentTripId);
            const currentDocuments = trip.documents || [];
            
            const newDocument = {
                id: Date.now().toString(),
                name: docName,
            };

            const updatedDocuments = [...currentDocuments, newDocument];
            const updates = { [`/${currentTripId}/documents`]: updatedDocuments };
            await update(tripsRef, updates);

            input.value = '';
        });

        document.getElementById('add-flight-form').addEventListener('submit', (e) => { e.preventDefault(); addDetail('flights'); });
        document.getElementById('add-transport-form').addEventListener('submit', (e) => { e.preventDefault(); addDetail('transport'); });
        document.getElementById('add-lodging-form').addEventListener('submit', (e) => { e.preventDefault(); addDetail('lodging'); });

        document.getElementById('edit-trip-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentTripId) return;
            const updates = {
                name: document.getElementById('edit-trip-name').value,
                destination: document.getElementById('edit-trip-destination').value,
                startDate: document.getElementById('edit-trip-start-date').value,
                endDate: document.getElementById('edit-trip-end-date').value,
                imageUrl: document.getElementById('edit-trip-image-url').value,
                customLinkText: document.getElementById('edit-trip-link-text').value.trim(),
                customLinkUrl: document.getElementById('edit-trip-link-url').value.trim(),
            };
            const tripToUpdateRef = ref(db, `public_trips/${currentTripId}`);
            await update(tripToUpdateRef, updates);
            closeModal('edit-trip-modal');
        });

        document.getElementById('edit-flight-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentTripId === null || currentEditingItemIndex === null) return;
            const trip = tripsData.find(t => t.id === currentTripId); if (!trip) return;
            const updatedFlight = {
                legType: document.getElementById('edit-flight-leg-type').value, date: document.getElementById('edit-flight-date').value, departureTime: document.getElementById('edit-flight-departure-time').value, arrivalTime: document.getElementById('edit-flight-arrival-time').value, origin: document.getElementById('edit-flight-origin').value, destination: document.getElementById('edit-flight-destination').value, company: document.getElementById('edit-flight-company').value, code: document.getElementById('edit-flight-code').value, flightType: document.getElementById('edit-flight-type').value,
            };
            const currentFlights = trip.flights ? [...Object.values(trip.flights)] : [];
            currentFlights[currentEditingItemIndex] = updatedFlight;
            const updates = { [`/${currentTripId}/flights`]: currentFlights };
            await update(tripsRef, updates);
            closeModal('edit-flight-modal');
            currentEditingItemIndex = null;
        });

        document.getElementById('edit-transport-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentTripId === null || currentEditingItemIndex === null) return;
            const trip = tripsData.find(t => t.id === currentTripId); if (!trip) return;
            const updatedTransport = {
                type: document.getElementById('edit-transport-type').value, from: document.getElementById('edit-transport-origin').value, to: document.getElementById('edit-transport-destination').value, description: document.getElementById('edit-transport-description').value, departureDate: document.getElementById('edit-transport-departure-date').value, departureTime: document.getElementById('edit-transport-departure-time').value, arrivalDate: document.getElementById('edit-transport-arrival-date').value, arrivalTime: document.getElementById('edit-transport-arrival-time').value,
            };
            const currentTransport = trip.transport ? [...Object.values(trip.transport)] : [];
            currentTransport[currentEditingItemIndex] = updatedTransport;
            const updates = { [`/${currentTripId}/transport`]: currentTransport };
            await update(tripsRef, updates);
            closeModal('edit-transport-modal');
            currentEditingItemIndex = null;
        });
        
        document.getElementById('edit-lodging-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (currentTripId === null || currentEditingItemIndex === null) return;
            const trip = tripsData.find(t => t.id === currentTripId); if (!trip) return;
            const updatedLodging = {
                name: document.getElementById('edit-lodging-name').value, address: document.getElementById('edit-lodging-address').value, checkinDate: document.getElementById('edit-lodging-checkin-date').value, checkinTime: document.getElementById('edit-lodging-checkin-time').value, checkoutDate: document.getElementById('edit-lodging-checkout-date').value, checkoutTime: document.getElementById('edit-lodging-checkout-time').value,
            };
            const currentLodging = trip.lodging ? [...Object.values(trip.lodging)] : [];
            currentLodging[currentEditingItemIndex] = updatedLodging;
            const updates = { [`/${currentTripId}/lodging`]: currentLodging };
            await update(tripsRef, updates);
            closeModal('edit-lodging-modal');
            currentEditingItemIndex = null;
        });

        document.getElementById('add-activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trip = tripsData.find(t => t.id === currentTripId);
            const newActivity = {
                id: Date.now().toString(),
                date: document.getElementById('activity-date').value,
                time: document.getElementById('activity-time').value,
                name: document.getElementById('activity-name').value,
                type: document.getElementById('activity-type').value,
                description: document.getElementById('activity-description').value,
                icon: document.getElementById('activity-icon').value,
                link: document.getElementById('activity-link').value.trim(),
            };
            const currentActivities = trip.activities ? [...Object.values(trip.activities)] : [];
            currentActivities.push(newActivity);
            const updates = { [`/${currentTripId}/activities`]: currentActivities };
            await update(tripsRef, updates);
            closeModal('add-activity-modal');
        });

        document.getElementById('edit-activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trip = tripsData.find(t => t.id === currentTripId);
            const activityId = document.getElementById('edit-activity-id').value;
            const currentActivities = trip.activities ? Object.values(trip.activities) : [];
            const activityIndex = currentActivities.findIndex(a => a.id === activityId);
            
            if (activityIndex > -1) {
                currentActivities[activityIndex] = {
                    ...currentActivities[activityIndex],
                    time: document.getElementById('edit-activity-time').value,
                    name: document.getElementById('edit-activity-name').value,
                    type: document.getElementById('edit-activity-type').value,
                    description: document.getElementById('edit-activity-description').value,
                    icon: document.getElementById('edit-activity-icon').value,
                    link: document.getElementById('edit-activity-link').value.trim(),
                };
                const updates = { [`/${currentTripId}/activities`]: currentActivities };
                await update(tripsRef, updates);
            }
            closeModal('edit-activity-modal');
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (typeof onConfirmAction === 'function') onConfirmAction();
        });

        function handleTransportTypeChange(selectElement) {
            const form = selectElement.closest('form');
            const originInput = form.querySelector('[id$="transport-origin"]');
            const destinationInput = form.querySelector('[id$="transport-destination"]');
            const originLabel = originInput.parentElement.querySelector('label');
            const destinationLabel = destinationInput.parentElement.querySelector('label');
            if (selectElement.value === 'Carro Alugado') {
                originInput.required = false; destinationInput.required = false;
                originLabel.innerText = 'Origem (Opcional)'; destinationLabel.innerText = 'Destino (Opcional)';
            } else {
                originInput.required = true; destinationInput.required = true;
                originLabel.innerText = 'Origem'; destinationLabel.innerText = 'Destino';
            }
        }
        
        document.getElementById('transport-type').addEventListener('change', (e) => handleTransportTypeChange(e.target));
        document.getElementById('edit-transport-type').addEventListener('change', (e) => handleTransportTypeChange(e.target));

        document.getElementById('trip-start-date').addEventListener('change', function(e) {
            const startDate = e.target.value;
            const endDateInput = document.getElementById('trip-end-date');
            if (startDate) {
                endDateInput.value = startDate;
                endDateInput.min = startDate; 
            }
        });
    </script>

</body></html>
