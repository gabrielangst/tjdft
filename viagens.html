<!DOCTYPE html>
<html lang="pt-BR"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador de Viagens Colaborativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .trip-card-delete-button {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .trip-card:hover .trip-card-delete-button {
            opacity: 1;
        }
        /* Estilos para o seletor de ícones */
        .icon-picker-option {
            transition: all 0.2s ease-in-out;
        }
        .icon-picker-option.selected {
            border-color: #3b82f6; /* blue-500 */
            background-color: #dbeafe; /* blue-100 */
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">

        <div id="trips-view">
            <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-slate-900">Nossas Viagens</h1>
                    <p class="text-slate-500 mt-1">Planeje e organize suas próximas aventuras em conjunto.</p>
                </div>
                <button onclick="openModal('add-trip-modal')" class="mt-4 sm:mt-0 flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="16"></line><line x1="8" x2="16" y1="12" y2="12"></line></svg>
                    <span>Nova Viagem</span>
                </button>
            </header>

            <main id="trips-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
        </div>

        <div id="details-view" class="hidden">
            <header class="mb-8">
                <button onclick="showTripsView()" class="flex items-center gap-2 text-slate-600 hover:text-slate-900 font-medium mb-4 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>
                    Voltar para todas as viagens
                </button>
                <h1 id="details-title" class="text-4xl font-bold text-slate-900"></h1>
                <p id="details-dates" class="text-slate-500 mt-1"></p>
                <div class="flex items-center gap-2 mt-4">
                    <button onclick="openModal('edit-image-modal')" class="flex items-center gap-2 text-sm bg-slate-200 text-slate-700 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>
                        <span>Alterar Imagem</span>
                    </button>
                    <button onclick="openModal('edit-trip-modal')" class="flex items-center gap-2 text-sm bg-slate-200 text-slate-700 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                        <span>Editar Viagem</span>
                    </button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Voos</h2>
                        <button onclick="openModal('add-flight-modal')" class="flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="flights-list" class="space-y-4"></div>
                </section>
                <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Transporte</h2>
                        <button onclick="openModal('add-transport-modal')" class="flex items-center justify-center w-10 h-10 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="transport-list" class="space-y-4"></div>
                </section>
                <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Hospedagens</h2>
                        <button onclick="openModal('add-lodging-modal')" class="flex items-center justify-center w-10 h-10 bg-purple-100 text-purple-600 rounded-full hover:bg-purple-200 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                    <div id="lodging-list" class="space-y-4"></div>
                </section>
            </main>

            <section id="daily-itinerary-panel" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Roteiro por Dia</h2>
                <div id="daily-itinerary-list" class="space-y-6">
                </div>
            </section>
        </div>
    </div>

    <div id="view-activity-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <div id="view-activity-icon" class="mx-auto mb-4 w-12 h-12 flex items-center justify-center bg-slate-100 text-slate-600 rounded-full">
                </div>
            <h3 id="view-activity-time" class="text-2xl font-semibold mb-4 text-center"></h3>
            <p id="view-activity-description" class="text-slate-600 text-center"></p>
            <div class="pt-6 flex justify-center">
                <button type="button" onclick="closeModal('view-activity-modal')" class="px-6 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300 transition-colors">Fechar</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Configuração do Firebase e variáveis globais
        const firebaseConfigManual = {
            apiKey: "AIzaSyBq4B9LCCat5jof2x9g5KN16UCOgnYo364",
            authDomain: "viagensapp-75077.firebaseapp.com",
            projectId: "viagensapp-75077",
            storageBucket: "viagensapp-75077.appspot.com",
            messagingSenderId: "231052282749",
            appId: "1:231052282749:web:2cd3cca2d77d4112dd1a14",
            databaseURL: "https://viagensapp-75077-default-rtdb.firebaseio.com"
        };
        let db, tripsRef;
        let tripsData = []; 
        let currentTripId = null;
        let currentEditingItemIndex = null;
        let onConfirmAction = () => {};

        function formatDate(dateString, options = { day: 'numeric', month: 'short', year: 'numeric' }) {
            if(!dateString) return 'Data indefinida';
            const date = new Date(dateString + 'T00:00:00Z');
            return date.toLocaleDateString('pt-BR', { timeZone: 'UTC', ...options });
        }

        const ICONS = {
            flight_departure: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>`,
            flight_arrival: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" transform="scale(1,-1)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>`,
            transport_departure: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l4-4-4-4"/><path d="M14 5v2a3 3 0 0 1-3 3H5a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h6a3 3 0 0 1 3 3v2"/></svg>`,
            transport_arrival: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15v5"/><path d="M9 12H3V5a2 2 0 0 1 2-2h4"/><path d="m14.2 12.6 7.2 7.2-2.8 2.8-7.2-7.2-2.8 2.8-4.4-4.4 2.8-2.8 4.4 4.4Z"/></svg>`,
            lodging_checkin: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            lodging_checkout: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>`,
            passeio: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`,
            restaurante: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m16 2-2.3 2.3a3 3 0 0 0 0 4.2l1.8 1.8a3 3 0 0 0 4.2 0L22 8"/><path d="M15 15 3.3 3.3a4.2 4.2 0 0 0 0 6l7.3 7.3c.7.7 2 .7 2.8 0L15 15Zm0 0 7 7"/><path d="m2.1 2.1 6.4 6.4"/></svg>`,
            outro: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12a10.06 10.06 1 0 0-20 0Z"/><path d="M12 12v8a2 2 0 0 0 4 0"/><path d="M12 2v1"/></svg>`,
            basketball: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 0-10 10c0 .2 0 .5.1.7"/><path d="M22 12a10 10 0 0 0-10-10c-.2 0-.5 0-.7.1"/><path d="M2 12h20"/><path d="M12 22a10 10 0 0 0 10-10c0-.2 0-.5-.1-.7"/><path d="M2 12a10 10 0 0 0 10 10c.2 0 .5 0 .7-.1"/></svg>`,
            building: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>`,
            pool: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/><path d="M3 12c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/><path d="M3 18c.9.5 2.2 1 3.5 1s2.6-.5 3.5-1 2.2 1 3.5 1 2.6-.5 3.5-1"/></svg>`,
            landmark: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" x2="21" y1="22"/><line x1="6" x2="6" y1="18"/><line x1="18" x2="18" y1="18"/><path d="M12 22V10"/><path d="m18 10-6-8-6 8"/><path d="M3 10h18"/></svg>`,
            shopping: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>`,
            music: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
            park: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14c-1-1-1-4 0-5 1-1 4-1 5 0 1 1 1 4 0 5-1 1-4 1-5 0Z"/><path d="m12.5 2.5.8 2.3.5 1.4.9.4.5.2 2.3.8.4.9.2.5 1.4.5.8 2.3.9.4.2.5.5 1.4 2.3.8.4.9.5.2.5 1.4.8 2.3-.9.4-.2.5-.5 1.4-2.3.8-1.4.5-.4.9-.8 2.3-.2.5-.5 1.4-.8 2.3-1.4.5-.9.4-.4.9-2.3.8-.5.2-.5 1.4-.8 2.3-.4.9-.2.5-.5 1.4z"/></svg>`,
            default: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                                ? JSON.parse(__firebase_config)
                                : firebaseConfigManual;

        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                tripsRef = ref(db, 'public_trips');
                setupTripsListener(); 
                setupIconPickers();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        } else {
            console.error("Firebase config is not available.");
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderTrips() {
            const tripsList = document.getElementById('trips-list');
            tripsList.innerHTML = ''; 

            if (tripsData.length === 0) {
                 tripsList.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-slate-700">Nenhuma viagem encontrada.</h3>
                    <p class="text-slate-500 mt-2">Clique em "Nova Viagem" para começar a planejar!</p>
                </div>`;
                return;
            }

            tripsData.forEach(trip => {
                const tripCard = document.createElement('div');
                tripCard.className = 'trip-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer transform hover:-translate-y-1 transition-transform duration-300 relative';
                tripCard.onclick = () => showTripDetails(trip.id);
                
                tripCard.innerHTML = `
                    <button onclick="deleteTrip(event, '${trip.id}')" class="trip-card-delete-button absolute top-3 right-3 z-10 w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                    <div class="h-48 bg-cover bg-center" style="background-image: url('${trip.imageUrl}')"></div>
                    <div class="p-6">
                        <h3 class="text-2xl font-bold text-slate-900">${trip.name}</h3>
                        <p class="text-slate-500 mt-1">${trip.destination}</p>
                        <div class="mt-4 text-sm font-medium text-slate-600">
                           ${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}
                        </div>
                    </div>
                `;
                tripsList.appendChild(tripCard);
            });
        }
        
        function renderTripDetails(tripId) {
            currentTripId = tripId;
            const trip = tripsData.find(t => t.id === tripId);

            if (!trip) {
                console.error("Viagem não encontrada:", tripId);
                showTripsView();
                return;
            }

            document.getElementById('details-title').textContent = trip.name;
            document.getElementById('details-dates').textContent = `${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}`;
            
            renderDailyItinerary(trip);

            const flightTemplate = (flight, index, allFlights) => `
                <div>
                    <p class="font-semibold text-slate-800">${flight.origin} → ${flight.destination}</p>
                    <p class="text-sm text-slate-600">${flight.company} ${flight.code} - ${formatDate(flight.date)}</p>
                    <p class="text-xs text-slate-500">${flight.departureTime} - ${flight.arrivalTime}</p>
                </div>
                <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('flights', ${index}, 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allFlights.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('flights', ${index}, 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m12 16 4-4-4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditFlightModal(${index})" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('flights', ${index})" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('flights-list', trip.flights, flightTemplate, 'Nenhum voo adicionado.');

            const transportTemplate = (item, index, allTransport) => `
                <div>
                    <p class="font-semibold text-slate-800">${item.type}</p>
                    <p class="text-sm text-slate-600">${item.from ? `${item.from} → ` : ''}${item.to ? item.to : ''}</p>
                    <p class="text-xs text-slate-500">${formatDate(item.departureDate)} às ${item.departureTime}</p>
                </div>
                <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('transport', ${index}, 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allTransport.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('transport', ${index}, 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m12 16 4-4-4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditTransportModal(${index})" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('transport', ${index})" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('transport-list', trip.transport, transportTemplate, 'Nenhum transporte adicionado.');

            const lodgingTemplate = (item, index, allLodging) => `
                <div>
                    <p class="font-semibold text-slate-800">${item.name}</p>
                    <p class="text-sm text-slate-600">${item.address}</p>
                    <p class="text-xs text-slate-500">Check-in: ${formatDate(item.checkinDate)}</p>
                </div>
                 <div class="flex flex-col gap-2 items-center">
                    <div class="flex gap-1">
                        <button ${index === 0 ? 'disabled' : ''} onclick="reorderDetailItem('lodging', ${index}, 'up')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up-circle"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>
                        </button>
                        <button ${index === allLodging.length - 1 ? 'disabled' : ''} onclick="reorderDetailItem('lodging', ${index}, 'down')" class="p-1 disabled:opacity-30 disabled:cursor-not-allowed">
                           <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-circle"><circle cx="12" cy="12" r="10"/><path d="m12 16 4-4-4-4"/><path d="m12 8 v8"/></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditLodgingModal(${index})" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button onclick="deleteDetailItem('lodging', ${index})" class="p-1 text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `;
            renderDetailList('lodging-list', trip.lodging, lodgingTemplate, 'Nenhuma hospedagem adicionada.');
        }
        
        function renderDailyItinerary(trip) {
            const container = document.getElementById('daily-itinerary-list');
            container.innerHTML = '';
            
            if (!trip.startDate || !trip.endDate) { return; }

            const allEvents = [];
            
            if (trip.flights) {
                Object.values(trip.flights).forEach(f => {
                    if (f.date && f.departureTime) {
                        const departureDateTime = new Date(`${f.date}T${f.departureTime}`);
                        allEvents.push({ 
                            dateTime: departureDateTime, 
                            description: `Partida do Voo ${f.company}: ${f.origin} → ${f.destination}`, 
                            isEditable: false, 
                            icon: ICONS.flight_departure 
                        });
                    }
                    if (f.date && f.arrivalTime) {
                        const departureDateTime = new Date(`${f.date}T${f.departureTime}`);
                        let arrivalDateTime = new Date(`${f.date}T${f.arrivalTime}`);
                        if (arrivalDateTime < departureDateTime) {
                            arrivalDateTime.setDate(arrivalDateTime.getDate() + 1);
                        }
                        allEvents.push({ 
                            dateTime: arrivalDateTime, 
                            description: `Chegada do Voo ${f.company} em ${f.destination}`, 
                            isEditable: false, 
                            icon: ICONS.flight_arrival 
                        });
                    }
                });
            }
            if (trip.transport) {
                Object.values(trip.transport).forEach(t => {
                    if (t.departureDate && t.departureTime) allEvents.push({ dateTime: new Date(`${t.departureDate}T${t.departureTime}`), description: `Embarque/Retirada (${t.type})`, isEditable: false, icon: ICONS.transport_departure });
                    if (t.arrivalDate && t.arrivalTime) allEvents.push({ dateTime: new Date(`${t.arrivalDate}T${t.arrivalTime}`), description: `Chegada/Devolução (${t.type})`, isEditable: false, icon: ICONS.transport_arrival });
                });
            }
            if (trip.lodging) {
                Object.values(trip.lodging).forEach(l => {
                    if (l.checkinDate && l.checkinTime) allEvents.push({ dateTime: new Date(`${l.checkinDate}T${l.checkinTime}`), description: `Check-in: ${l.name}`, isEditable: false, icon: ICONS.lodging_checkin });
                    if (l.checkoutDate && l.checkoutTime) allEvents.push({ dateTime: new Date(`${l.checkoutDate}T${l.checkoutTime}`), description: `Check-out: ${l.name}`, isEditable: false, icon: ICONS.lodging_checkout });
                });
            }
            if (trip.activities) {
                Object.values(trip.activities).forEach(a => {
                    const activityIcon = ICONS[a.icon] || (a.type === 'Passeio' ? ICONS.passeio : a.type === 'Restaurante' ? ICONS.restaurante : ICONS.outro);
                    if(a.date && a.time) allEvents.push({ id: a.id, dateTime: new Date(`${a.date}T${a.time}`), description: a.description, isEditable: true, icon: activityIcon });
                });
            }

            allEvents.sort((a,b) => a.dateTime - b.dateTime);

            const groupedByDay = allEvents.reduce((acc, event) => {
                const date = new Date(event.dateTime);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                const day = date.toISOString().split('T')[0];
                if (!acc[day]) acc[day] = [];
                acc[day].push(event);
                return acc;
            }, {});

            let currentDate = new Date(trip.startDate + 'T00:00:00Z');
            const endDate = new Date(trip.endDate + 'T23:59:59Z');

            while(currentDate <= endDate) {
                const dayKey = currentDate.toISOString().split('T')[0];
                const dayEvents = groupedByDay[dayKey] || [];
                
                const dayPanel = document.createElement('div');
                dayPanel.className = 'border-t pt-4';
                
                let eventsHtml = dayEvents.map(event => {
                    const bgColorStyle = event.isEditable ? 'background-color: #e6f1ff;' : '';
                    const descriptionEscaped = event.description.replace(/"/g, '&quot;');
                    const time = event.dateTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});

                    return `
                    <div 
                        class="flex items-center justify-between gap-4 p-2 rounded-md cursor-pointer hover:bg-slate-100" 
                        style="${bgColorStyle}"
                        onclick="openViewActivityModal(this)"
                        data-icon='${event.icon}'
                        data-time="${time}"
                        data-description="${descriptionEscaped}"
                    >
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <span class="font-bold text-sm w-12 text-right flex-shrink-0">${time}</span>
                            <div class="flex items-center gap-2 text-slate-500 flex-shrink-0">${event.icon || ''}</div>
                            <p class="text-sm text-slate-700 truncate">${event.description}</p>
                        </div>
                        ${event.isEditable ? `
                        <div class="flex gap-2 items-center flex-shrink-0">
                            <button onclick="event.stopPropagation(); openEditActivityModal('${event.id}')" class="text-slate-500 hover:text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteActivity('${event.id}')" class="text-slate-500 hover:text-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `}).join('');

                if (dayEvents.length === 0) {
                    eventsHtml = '<p class="text-sm text-slate-400 py-2 ml-4">Nenhuma atividade para este dia.</p>';
                }

                dayPanel.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg text-slate-800">${formatDate(dayKey, {weekday: 'long', day: 'numeric', month: 'long'})}</h3>
                        <button onclick="openAddActivityModal('${dayKey}')" class="flex items-center gap-1 text-sm bg-blue-50 text-blue-600 font-semibold px-3 py-1 rounded-md hover:bg-blue-100 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Adicionar Atividade
                        </button>
                    </div>
                    <div class="border-l-2 border-slate-100 pl-2 space-y-1">${eventsHtml}</div>
                `;
                container.appendChild(dayPanel);
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }
        }
        
        function renderDetailList(elementId, items, itemTemplate, emptyMessage) {
            const listElement = document.getElementById(elementId);
            listElement.innerHTML = '';
            const itemsArray = items ? Object.values(items) : [];
            if (itemsArray.length === 0) {
                listElement.innerHTML = `<p class="text-slate-500 text-sm">${emptyMessage}</p>`;
                return;
            }
            itemsArray.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-start border-l-4 border-slate-200 pl-4 py-2';
                itemDiv.innerHTML = itemTemplate(item, index, itemsArray);
                listElement.appendChild(itemDiv);
            });
        }
        
        function setupTripsListener() {
            if (!tripsRef) return;
            onValue(tripsRef, (snapshot) => {
                const data = snapshot.val();
                tripsData = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                
                if (document.getElementById('details-view').classList.contains('hidden')) {
                    renderTrips();
                } else if(currentTripId) {
                    const currentTripExists = tripsData.some(t => t.id === currentTripId);
                    if (currentTripExists) {
                        renderTripDetails(currentTripId);
                    } else {
                        showTripsView();
                    }
                }
            }, error => {
                console.error("Error listening to Realtime Database:", error);
            });
        }

        function setupIconPickers() {
            const iconOptions = {
                passeio: ICONS.passeio, restaurante: ICONS.restaurante, outro: ICONS.outro,
                basketball: ICONS.basketball, building: ICONS.building, pool: ICONS.pool,
                landmark: ICONS.landmark, shopping: ICONS.shopping, music: ICONS.music, park: ICONS.park
            };

            const populatePicker = (pickerId) => {
                const picker = document.getElementById(pickerId);
                picker.innerHTML = '';
                for (const [name, svg] of Object.entries(iconOptions)) {
                    const option = document.createElement('div');
                    option.className = 'icon-picker-option cursor-pointer p-2 border-2 border-slate-200 rounded-full';
                    option.dataset.icon = name;
                    option.innerHTML = svg.replace('w-5 h-5', 'w-6 h-6'); // Make icons in picker slightly larger
                    picker.appendChild(option);
                }
            };

            const handlePickerClick = (e, formId) => {
                const target = e.target.closest('.icon-picker-option');
                if (!target) return;

                const iconName = target.dataset.icon;
                const picker = target.parentElement;
                const hiddenInput = document.getElementById(formId);

                hiddenInput.value = iconName;

                picker.querySelectorAll('.icon-picker-option').forEach(opt => opt.classList.remove('selected'));
                target.classList.add('selected');
            };

            populatePicker('add-icon-picker');
            populatePicker('edit-icon-picker');

            document.getElementById('add-icon-picker').addEventListener('click', (e) => handlePickerClick(e, 'activity-icon'));
            document.getElementById('edit-icon-picker').addEventListener('click', (e) => handlePickerClick(e, 'edit-activity-icon'));
        }
        
        // --- CONTROLE DE NAVEGAÇÃO, MODAIS E FORMULÁRIOS ---
        window.showTripsView = () => {
            document.getElementById('trips-view').classList.remove('hidden');
            document.getElementById('details-view').classList.add('hidden');
            currentTripId = null;
        }

        window.showTripDetails = (tripId) => {
            renderTripDetails(tripId);
            document.getElementById('trips-view').classList.add('hidden');
            document.getElementById('details-view').classList.remove('hidden');
        }

        window.openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.replace('hidden', 'flex');
        }

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.replace('flex', 'hidden');
            const form = document.getElementById(modalId).querySelector('form');
            if (form) form.reset();
            if (modalId === 'confirm-delete-modal') onConfirmAction = () => {};
        }

        window.openViewActivityModal = (element) => {
            const iconHTML = element.dataset.icon;
            const time = element.dataset.time;
            const description = element.dataset.description;

            document.getElementById('view-activity-icon').innerHTML = iconHTML.replace('w-5 h-5', 'w-8 h-8');
            document.getElementById('view-activity-time').textContent = time;
            document.getElementById('view-activity-description').textContent = description;
            openModal('view-activity-modal');
        }
        
        // ... (Restante das funções, como openEdit...Modals, delete... etc., permanecem aqui) ...

    </script>

</body></html>
